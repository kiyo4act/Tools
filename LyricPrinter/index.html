<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>歌詞HTML整形ツール (for Print) v5.4</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            text-align: center;
            color: #333;
        }
        textarea {
            width: 98%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .controls-section, .url-fetch-area {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            display: flex; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        .controls-section label, .url-fetch-area label {
            margin-right: 10px;
            font-weight: bold;
            flex-shrink: 0; 
        }
        .controls-section input[type="range"] {
            width: 200px;
            vertical-align: middle;
        }
        .url-fetch-area input[type="text"] {
            flex-grow: 1; 
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px; 
            min-width: 200px; 
        }
        .url-fetch-area button {
            flex-shrink: 0; 
        }
        button {
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 10px;
            transition: background-color 0.3s;
            vertical-align: middle;
        }
        button:last-child {
            margin-right: 0;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.control-btn { 
            padding: 2px 6px;
            font-size: 0.8em;
            margin-left: 5px; /* Adjusted margin for multiple buttons */
            margin-right: 0; 
            background-color: #6c757d;
            color:white;
            border:none;
            border-radius:3px;
            cursor:pointer;
        }
        button.control-btn:hover {
            background-color: #5a6268;
        }
        button#downloadHtmlBtnEl { background-color: #28a745; } 
        button#downloadHtmlBtnEl:hover { background-color: #1e7e34; }
        button#printBtnEl { background-color: #17a2b8; } 
        button#printBtnEl:hover { background-color: #138496; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #outputContainerEl { margin-top: 20px; border: 1px solid #ddd; padding: 15px; background-color: #f9f9f9; border-radius: 4px; min-height: 100px; }
        iframe#outputFrameEl { width: 100%; height: 400px; border: 1px solid #ccc; }
        .instructions { background-color: #e9ecef; padding: 15px; border-radius: 4px; margin-bottom: 20px; font-size: 0.9em; }
        .instructions ul { padding-left: 20px; }
        .status-message { 
            margin-left: 10px; 
            font-size: 0.9em;
            flex-grow: 1;
            text-align: left;
        }
        .status-message.error { color: red; font-weight: bold; }
        .status-message.success { color: green; }
        .loader { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; vertical-align: middle; margin-left: 10px; flex-shrink: 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .page-break-preview-indicator { text-align:center; color:blue; font-size:0.8em; border-top:1px dashed blue; margin: 5px 0; padding: 2px 0; user-select: none; }
        .action-buttons { 
            margin-top: 15px;
            text-align: center; 
        }
        .action-buttons button {
            margin: 5px;
        }
        .br-placeholder.space-added::before { /* Show the added space visually */
            content: "' '"; /* Visual cue for added space */
            color: #aaa;
            font-style: italic;
            font-size: 0.8em;
        }
        .br-placeholder.no-space { /* No visual cue when no space */
             /* display: none; /* Or ensure it takes no space if it's an element */
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>歌詞HTML整形ツール (for Print) v5.4</h1>
        <div class="instructions">
             <p><strong>使い方:</strong></p>
            <ul>
                <li>方法1: URLを入力し「読み込み実行」後、下のテキストエリアにHTMLが読み込まれます (<code>utaten.com</code> のみ)。</li>
                <li>方法2: HTML断片を直接テキストエリアに貼り付けます。</li>
                <li>歌詞フォントサイズをスライダーで調整します。</li>
                <li>「整形して表示」でプレビューを生成。プレビュー内のボタンで改行・空白・改ページを調整できます。</li>
                <li>「生成HTMLをダウンロード」でファイルを保存、または「印刷」ボタンで直接印刷できます。</li>
            </ul>
        </div>

        <h3>URLからHTML断片を読み込む (CORSプロキシ経由)</h3>
        <div class="url-fetch-area">
            <label for="urlInputEl">URL (utaten.comのみ):</label>
            <input type="text" id="urlInputEl" placeholder="https://utaten.com/lyric/xxxxxx/">
            <button id="fetchUrlBtnEl">読み込み実行</button>
            <div class="loader" id="urlLoaderEl"></div>
            <div id="urlStatusEl" class="status-message"></div>
        </div>

        <h3>HTML断片入力</h3>
        <textarea id="htmlInputEl" placeholder="ここにHTMLの断片を貼り付けるか、上記URLから読み込んでください..."></textarea>

        <div class="controls-section">
            <label for="fontSizeSliderEl">歌詞フォントサイズ: <span id="fontSizeValueDisplayEl">20</span>pt</label>
            <input type="range" id="fontSizeSliderEl" min="8" max="28" value="20">
        </div>
        
        <div class="action-buttons">
            <button id="generatePreviewBtnEl">整形して表示</button>
            <button id="downloadHtmlBtnEl" disabled>生成HTMLをダウンロード</button>
            <button id="printBtnEl" disabled>印刷</button>
        </div>


        <h2>整形後プレビュー</h2>
        <div id="outputContainerEl">
            <iframe id="outputFrameEl" title="整形後HTMLプレビュー"></iframe>
        </div>
        <p style="font-size: 0.8em; text-align: center; margin-top: 20px;">
            このツールはクライアントサイドで動作します。入力データはサーバーに送信されません。
        </p>
    </div>

    <script>
        const htmlInputEl = document.getElementById('htmlInputEl');
        const generatePreviewBtnEl = document.getElementById('generatePreviewBtnEl');
        const downloadHtmlBtnEl = document.getElementById('downloadHtmlBtnEl');
        const printBtnEl = document.getElementById('printBtnEl');
        const outputFrameEl = document.getElementById('outputFrameEl');
        const fontSizeSliderEl = document.getElementById('fontSizeSliderEl');
        const fontSizeValueDisplayEl = document.getElementById('fontSizeValueDisplayEl');
        const urlInputEl = document.getElementById('urlInputEl');
        const fetchUrlBtnEl = document.getElementById('fetchUrlBtnEl');
        const urlStatusEl = document.getElementById('urlStatusEl');
        const urlLoaderEl = document.getElementById('urlLoaderEl');

        let songInfo = {};
        let originalLyricsLines = []; 
        let normalLineBreakStates = []; 
        let pageBreakAfterLineStates = [];
        let addSpaceOnBrRemovalStates = []; // ★新機能: 空白追加の状態管理
        
        fontSizeValueDisplayEl.textContent = fontSizeSliderEl.value;

        fontSizeSliderEl.addEventListener('input', (event) => {
            fontSizeValueDisplayEl.textContent = event.target.value;
            if (outputFrameEl.contentDocument && outputFrameEl.contentDocument.body && outputFrameEl.contentDocument.body.innerHTML) {
                 const iframeDoc = outputFrameEl.contentDocument;
                 const lyricsEl = iframeDoc.querySelector('.lyrics');
                 if (lyricsEl) {
                     lyricsEl.style.fontSize = event.target.value + 'pt';
                 }
            }
        });

        fetchUrlBtnEl.addEventListener('click', async () => {
            const targetUrl = urlInputEl.value.trim();
            if (!targetUrl) {
                urlStatusEl.textContent = 'URLを入力してください。';
                urlStatusEl.className = 'status-message error'; return;
            }
            try {
                const urlObject = new URL(targetUrl);
                if (urlObject.hostname !== 'utaten.com' && urlObject.hostname !== 'www.utaten.com') {
                    urlStatusEl.textContent = 'utaten.com のURLのみ有効です。';
                    urlStatusEl.className = 'status-message error'; return;
                }
            } catch (e) {
                urlStatusEl.textContent = '無効なURL形式です。';
                urlStatusEl.className = 'status-message error'; return;
            }
            urlLoaderEl.style.display = 'inline-block';
            urlStatusEl.textContent = '読み込み中...';
            urlStatusEl.className = 'status-message';
            fetchUrlBtnEl.disabled = true;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} (プロキシまたは対象サイトの問題の可能性があります)`);
                htmlInputEl.value = await response.text();
                urlStatusEl.textContent = 'HTMLの読み込みに成功しました。';
                urlStatusEl.className = 'status-message success';
            } catch (error) {
                console.error('Fetch error:', error);
                urlStatusEl.textContent = `URL取得失敗: ${error.message}. 手動コピー＆ペーストしてください。`;
                urlStatusEl.className = 'status-message error';
            } finally {
                urlLoaderEl.style.display = 'none';
                fetchUrlBtnEl.disabled = false;
            }
        });

        generatePreviewBtnEl.addEventListener('click', () => {
            const rawHtml = htmlInputEl.value;
            if (!rawHtml.trim()) { alert('HTML断片を入力してください。'); return; }
            const parser = new DOMParser();
            const doc = parser.parseFromString(rawHtml, 'text/html');

            songInfo.title = (doc.querySelector('h2.newLyricTitle__main')?.textContent.replace('歌詞', '').trim()) || "タイトル不明";
            songInfo.artist = (doc.querySelector('div.lyricData__main h3 a')?.textContent.trim()) || "アーティスト不明";
            songInfo.releaseDate = (doc.querySelector('dd.newLyricWork__date')?.textContent.replace('リリース', '').trim()) || "リリース日不明";
            
            let lyricist = "作詞者不明"; let composer = "作曲者不明";
            doc.querySelectorAll('dl.newLyricWork dt.newLyricWork__title').forEach(dt => {
                const dd = dt.nextElementSibling;
                if (dd) {
                    const text = (dd.querySelector('a') || dd).textContent.trim();
                    if (dt.textContent.trim() === '作詞') lyricist = text || "作詞者不明";
                    if (dt.textContent.trim() === '作曲') composer = text || "作曲者不明";
                }
            });
            songInfo.lyricist = lyricist; songInfo.composer = composer;

            let rawLyricsHtml = doc.querySelector('div.hiragana')?.innerHTML || "<p>歌詞が見つかりません。</p>";
            rawLyricsHtml = rawLyricsHtml.replace(/<span class="ruby"><span class="rb">([^<]+)<\/span><span class="rt">([^<]+)<\/span><\/span>/g, '<ruby>$1<rt>$2</rt></ruby>');
            
            originalLyricsLines = rawLyricsHtml.split(/<br\s*\/?>/i).map(line => line.trim());
            normalLineBreakStates = Array(originalLyricsLines.length - 1).fill(true);
            pageBreakAfterLineStates = Array(originalLyricsLines.length -1).fill(false);
            addSpaceOnBrRemovalStates = Array(originalLyricsLines.length - 1).fill(false); // ★新機能: 初期化

            displayFullPreview();
            downloadHtmlBtnEl.disabled = false;
            printBtnEl.disabled = false;
        });

        function displayFullPreview() {
            const currentFontSize = fontSizeSliderEl.value;
            let lyricsHtmlForPreview = '';
            originalLyricsLines.forEach((line, index) => {
                lyricsHtmlForPreview += `<span class="lyric-line-content">${line}</span>`;

                if (index < originalLyricsLines.length - 1) { 
                    const isEffectivelyEmptyLine = line.replace(/<[^>]+>/g, '').trim() === '';

                    if (isEffectivelyEmptyLine) {
                        if (pageBreakAfterLineStates[index]) {
                            lyricsHtmlForPreview += `<button class="control-btn remove-pb-btn" data-line-index="${index}">改ページ削除</button>`;
                        } else {
                            lyricsHtmlForPreview += `<button class="control-btn add-pb-btn" data-line-index="${index}">改ページ追加</button>`;
                        }
                    }

                    if (normalLineBreakStates[index]) { // BRが表示されている
                        lyricsHtmlForPreview += `<button class="control-btn remove-br-btn" data-line-index="${index}">改行削除</button>`;
                        lyricsHtmlForPreview += `<br data-br-index="${index}">`;
                    } else { // BRが削除されている
                        lyricsHtmlForPreview += `<button class="control-btn restore-br-btn" data-line-index="${index}">改行追加</button>`;
                        // ★新機能: 空白追加/削除ボタン
                        if (addSpaceOnBrRemovalStates[index]) {
                            lyricsHtmlForPreview += `<button class="control-btn toggle-space-btn" data-line-index="${index}" data-action="remove_space">空白削除</button>`;
                            lyricsHtmlForPreview += `<span class="br-placeholder space-added" data-br-index="${index}"> </span>`;
                        } else {
                            lyricsHtmlForPreview += `<button class="control-btn toggle-space-btn" data-line-index="${index}" data-action="add_space">空白追加</button>`;
                            lyricsHtmlForPreview += `<span class="br-placeholder no-space" data-br-index="${index}"></span>`;
                        }
                    }
                    if (pageBreakAfterLineStates[index]) {
                        lyricsHtmlForPreview += `<div class="page-break-preview-indicator">-- 改ページ指示箇所 --</div>`;
                    }
                }
            });

            const previewContent = `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>${songInfo.title} - プレビュー</title><style>
                body { font-family: 'MS Mincho', 'Hiragino Mincho ProN', Meiryo, sans-serif; margin: 10px; font-size: 12pt; }
                h1 { font-size: 18pt; text-align: center; margin-bottom: 10px; font-weight: bold; }
                .song-info { text-align: right; margin-bottom: 20px; font-size: 9pt; } .song-info p { margin: 2px 0; }
                .lyrics { margin-top: 15px; text-align: left; font-size: ${currentFontSize}pt; line-height: 2.2; }
                ruby { display: ruby; ruby-position: over !important; line-height: initial; }
                ruby rt { font-size: 0.55em; opacity: 0.95; user-select: none; }
                .lyric-line-content { display: inline; }
                button.control-btn { padding:1px 4px; font-size:0.75em; margin-left:5px; background-color:#6c757d; color:white; border:none; border-radius:3px; cursor:pointer; vertical-align: baseline;}
                button.control-btn:hover { background-color:#5a6268; }
                .br-placeholder { /* Empty, no space for removed BR by default */ }
                .br-placeholder.space-added::before { content: "' '"; color: #ccc; font-style: italic; font-size:0.8em; margin: 0 2px; } /* Visual cue */
                .page-break-preview-indicator { text-align:center; color:blue; font-size:0.8em; border-top:1px dashed blue; margin: 5px 0; padding: 2px 0; user-select: none;}
            </style></head><body><h1>${songInfo.title}</h1><div class="song-info"><p>アーティスト: ${songInfo.artist}</p><p>作詞: ${songInfo.lyricist}</p><p>作曲: ${songInfo.composer}</p><p>リリース日: ${songInfo.releaseDate}</p></div><div class="lyrics">${lyricsHtmlForPreview}</div></body></html>`;
            
            const iframeDoc = outputFrameEl.contentDocument || outputFrameEl.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(previewContent);
            iframeDoc.close();
            
            setTimeout(() => attachControlListeners(iframeDoc), 100);
        }
        
        function attachControlListeners(iframeDoc) {
            iframeDoc.querySelectorAll('.remove-br-btn').forEach(b => b.onclick = () => toggleNormalBreak(parseInt(b.dataset.lineIndex), false));
            iframeDoc.querySelectorAll('.restore-br-btn').forEach(b => b.onclick = () => toggleNormalBreak(parseInt(b.dataset.lineIndex), true));
            iframeDoc.querySelectorAll('.add-pb-btn').forEach(b => b.onclick = () => togglePageBreak(parseInt(b.dataset.lineIndex), true));
            iframeDoc.querySelectorAll('.remove-pb-btn').forEach(b => b.onclick = () => togglePageBreak(parseInt(b.dataset.lineIndex), false));
            // ★新機能: 空白追加/削除ボタンのリスナー
            iframeDoc.querySelectorAll('.toggle-space-btn').forEach(button => {
                button.onclick = () => {
                    const index = parseInt(button.dataset.lineIndex);
                    const action = button.dataset.action;
                    toggleSpaceState(index, action === "add_space");
                };
            });
        }

        function toggleNormalBreak(index, showBr) {
            if (index >= 0 && index < normalLineBreakStates.length) {
                normalLineBreakStates[index] = showBr;
                // Optionally, if a BR is restored, reset the "add space" state for that line,
                // as the space is only relevant when the BR is removed.
                // if (showBr) {
                //    addSpaceOnBrRemovalStates[index] = false;
                // }
                displayFullPreview();
            }
        }
        function togglePageBreak(index, addPb) {
             if (index >= 0 && index < pageBreakAfterLineStates.length) {
                pageBreakAfterLineStates[index] = addPb;
                displayFullPreview();
            }
        }
        // ★新機能: 空白状態をトグルする関数
        function toggleSpaceState(index, addSpace) {
            if (index >= 0 && index < addSpaceOnBrRemovalStates.length) {
                addSpaceOnBrRemovalStates[index] = addSpace;
                displayFullPreview();
            }
        }


        function generateFinalHtmlForOutput() {
            const currentFontSize = fontSizeSliderEl.value;
            let lyricsHtmlOutput = '';
            originalLyricsLines.forEach((line, index) => {
                lyricsHtmlOutput += line; 
                
                if (index < normalLineBreakStates.length) { // Not the last line segment
                    if (normalLineBreakStates[index]) { // If there's a normal BR
                        lyricsHtmlOutput += '<br>';
                    } else { // BR is removed
                        // ★新機能: 条件に応じて空白を挿入
                        if (addSpaceOnBrRemovalStates[index]) {
                            lyricsHtmlOutput += ' '; 
                        }
                        // Else: no BR, no space (direct concatenation)
                    }
                }
                // Add page break div *after* the line and its BR/space logic
                if (index < pageBreakAfterLineStates.length && pageBreakAfterLineStates[index]) {
                    lyricsHtmlOutput += '<div class="print-page-break-element"></div>';
                }
            });

            return `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>${songInfo.title} - 歌詞</title><style>
                body { font-family: 'MS Mincho', 'Hiragino Mincho ProN', Meiryo, sans-serif; margin: 20mm; font-size: 12pt; background-color: #fff; color: #000; }
                h1 { font-size: 20pt; text-align: center; margin-bottom: 15px; font-weight: bold; }
                .song-info { text-align: right; margin-bottom: 25px; font-size: 10pt; } .song-info p { margin: 3px 0; }
                .lyrics { margin-top: 20px; text-align: left; font-size: ${currentFontSize}pt; line-height: 2.2; column-count: 1; }
                ruby { display: ruby; ruby-position: over !important; line-height: initial; }
                ruby rt { font-size: 0.55em; opacity: 0.95; user-select: none; }
                @media print {
                    body { margin: 15mm; font-size: 11pt; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                    h1 { font-size: 18pt; }
                    .song-info { font-size: 9pt; }
                    .lyrics { font-size: ${Math.max(8, parseInt(currentFontSize) - 1)}pt; line-height: 2.0; }
                    .print-page-break-element { 
                        page-break-after: always !important; 
                        display: block !important; height: 0 !important; line-height: 0 !important; font-size: 0 !important;
                        margin: 0 !important; padding: 0 !important; border: none !important;
                        visibility: visible !important; content: ""; 
                    }
                }
                .print-page-break-element { display: none; }
            </style></head><body><h1>${songInfo.title}</h1><div class="song-info"><p>アーティスト: ${songInfo.artist}</p><p>作詞: ${songInfo.lyricist}</p><p>作曲: ${songInfo.composer}</p><p>リリース日: ${songInfo.releaseDate}</p></div><div class="lyrics">${lyricsHtmlOutput}</div></body></html>`;
        }

        downloadHtmlBtnEl.addEventListener('click', () => {
            if (!songInfo.title) { alert('先に「整形して表示」を実行してください。'); return; }
            const finalHtmlContent = generateFinalHtmlForOutput();
            let filename = (songInfo.title && songInfo.title !== "タイトル不明") ? songInfo.title.replace(/[\\/*?:"<>|]/g, "_") + ".html" : "lyrics_formatted.html";
            const blob = new Blob([finalHtmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        });

        printBtnEl.addEventListener('click', () => {
            if (!songInfo.title) { alert('先に「整形して表示」を実行してください。'); return; }
            const finalHtmlContent = generateFinalHtmlForOutput();
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.open();
            printWindow.document.write(finalHtmlContent);
            printWindow.document.close();
            
            const attemptPrint = () => {
                try {
                    if (!printWindow || printWindow.closed) { return; }
                    if (printWindow.document.readyState === "complete") {
                        printWindow.focus(); printWindow.print();
                    } else { setTimeout(attemptPrint, 200); }
                } catch (e) { console.error("Error during print attempt:", e); }
            };
            if (printWindow) {
                if (printWindow.document.readyState === "complete") { attemptPrint(); }
                else { printWindow.onload = attemptPrint; setTimeout(attemptPrint, 500); }
            } else { alert("印刷ウィンドウを開けませんでした。ポップアップブロッカーを確認してください。"); }
        });
    </script>
</body>
</html>
