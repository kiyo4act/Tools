<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>フリマ設定価格計算ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    <meta name="description" content="手数料・送料を考慮して利益や価格を自動計算するツール。メルカリ、ラクマ、Yahoo!フリマに対応。">
    <!-- OGP / Twitter Card -->
    <meta property="og:title" content="フリマ設定価格計算ツール">
    <meta property="og:description" content="手数料・送料を考慮して利益や価格を自動計算するツール。メルカリ、ラクマ、Yahoo!フリマに対応。">
    <meta property="og:image" content="https://kiyo.bio/Tools/FleamarketValueCalculator/ogp.png">
    <meta property="og:url" content="https://kiyo.bio/Tools/FleamarketValueCalculator/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="kiyo.bio">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="フリマ設定価格計算ツール">
    <meta name="twitter:description" content="手数料・送料を考慮して利益や価格を自動計算するツール。メルカリ、ラクマ、Yahoo!フリマに対応。">
    <meta name="twitter:image" content="https://kiyo.bio/Tools/FleamarketValueCalculator/ogp.png">
    <meta name="last-updated" content="2026-02-08">
    <meta name="category" content="シミュレーション">
</head>

<body class="bg-slate-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icon Components (replacing lucide-react) ---
        const SvgIcon = ({ className, children }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                {children}
            </svg>
        );

        const Calculator = ({ className }) => (
            <SvgIcon className={className}>
                <rect width="16" height="20" x="4" y="2" rx="2" />
                <line x1="8" x2="16" y1="6" y2="6" />
                <line x1="16" x2="16" y1="14" y2="18" />
                <path d="M16 10h.01" /><path d="M12 10h.01" /><path d="M8 10h.01" />
                <path d="M12 14h.01" /><path d="M8 14h.01" />
                <path d="M12 18h.01" /><path d="M8 18h.01" />
            </SvgIcon>
        );

        const ArrowRightLeft = ({ className }) => (
            <SvgIcon className={className}>
                <path d="m16 3 4 4-4 4" /><path d="M20 7H4" />
                <path d="m8 21-4-4 4-4" /><path d="M4 17h16" />
            </SvgIcon>
        );

        const ExternalLink = ({ className }) => (
            <SvgIcon className={className}>
                <path d="M15 3h6v6" /><path d="M10 14 21 3" />
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
            </SvgIcon>
        );

        const Coins = ({ className }) => (
            <SvgIcon className={className}>
                <circle cx="8" cy="8" r="6" />
                <path d="M18.09 10.37A6 6 0 1 1 10.34 18" />
                <path d="M7 6h1v4" /><path d="m16.71 13.88.7.71-2.82 2.82" />
            </SvgIcon>
        );

        const TrendingUp = ({ className }) => (
            <SvgIcon className={className}>
                <polyline points="22 7 13.5 15.5 8.5 10.5 2 17" />
                <polyline points="16 7 22 7 22 13" />
            </SvgIcon>
        );

        const Info = ({ className }) => (
            <SvgIcon className={className}>
                <circle cx="12" cy="12" r="10" />
                <path d="M12 16v-4" /><path d="M12 8h.01" />
            </SvgIcon>
        );

        const ChevronRight = ({ className }) => (
            <SvgIcon className={className}>
                <path d="m9 18 6-6-6-6" />
            </SvgIcon>
        );

        const Truck = ({ className }) => (
            <SvgIcon className={className}>
                <path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2" />
                <path d="M15 18H9" />
                <path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14" />
                <circle cx="17" cy="18" r="2" /><circle cx="7" cy="18" r="2" />
            </SvgIcon>
        );

        const Settings = ({ className }) => (
            <SvgIcon className={className}>
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                <circle cx="12" cy="12" r="3" />
            </SvgIcon>
        );

        const Plus = ({ className }) => (
            <SvgIcon className={className}>
                <path d="M5 12h14" /><path d="M12 5v14" />
            </SvgIcon>
        );

        const Trash2 = ({ className }) => (
            <SvgIcon className={className}>
                <path d="M3 6h18" />
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                <line x1="10" x2="10" y1="11" y2="17" />
                <line x1="14" x2="14" y1="11" y2="17" />
            </SvgIcon>
        );

        // --- Constants & Data ---

        const PLATFORMS = [
            {
                id: 'yahoo',
                name: 'Yahoo!フリマ',
                feeRate: 0.05,
                feeType: 'percent',
                color: 'bg-yellow-500',
                borderHex: '#eab308',
                shippingUrl: 'https://paypayfleamarket.yahoo.co.jp/contents/shipping',
                supportsBuyerShipping: false,
                shippingCategories: [
                    {
                        name: 'おてがる配送（ヤマト運輸）',
                        methods: [
                            { name: 'ネコポス', sizes: [{ name: '全国一律', price: 210 }] },
                            { name: '宅急便コンパクト（EAZY）', sizes: [{ name: '全国一律', price: 490 }] },
                            {
                                name: '宅急便（EAZY）',
                                sizes: [
                                    { name: '60サイズ (2kg以内)', price: 750 },
                                    { name: '80サイズ (5kg以内)', price: 850 },
                                    { name: '100サイズ (10kg以内)', price: 1050 },
                                    { name: '120サイズ (15kg以内)', price: 1200 },
                                    { name: '140サイズ (20kg以内)', price: 1400 },
                                    { name: '160サイズ (25kg以内)', price: 1700 },
                                    { name: '180サイズ (30kg以内)', price: 2100 },
                                    { name: '200サイズ (30kg以内)', price: 2500 },
                                ]
                            },
                        ]
                    },
                    {
                        name: 'おてがる配送（日本郵便）',
                        methods: [
                            { name: 'ゆうパケットポストmini', sizes: [{ name: '全国一律', price: 160 }] },
                            { name: 'ゆうパケット', sizes: [{ name: '全国一律', price: 215 }] },
                            { name: 'ゆうパケットポスト', sizes: [{ name: '全国一律', price: 210 }] },
                            { name: 'ゆうパケットプラス', sizes: [{ name: '全国一律', price: 410 }] },
                            {
                                name: 'ゆうパック',
                                sizes: [
                                    { name: '60サイズ', price: 750 },
                                    { name: '80サイズ', price: 850 },
                                    { name: '100サイズ', price: 1050 },
                                    { name: '120サイズ', price: 1200 },
                                    { name: '140サイズ', price: 1400 },
                                    { name: '160サイズ', price: 1700 },
                                    { name: '170サイズ', price: 1900 },
                                ]
                            },
                        ]
                    },
                    {
                        name: 'おまかせ配送（大型家具・家電）',
                        methods: [
                            {
                                name: 'おまかせ配送',
                                sizes: [
                                    { name: '80サイズ (1700円)', price: 1700 },
                                    { name: '120サイズ (2400円)', price: 2400 },
                                    { name: '160サイズ (3400円)', price: 3400 },
                                    { name: '200サイズ (5000円)', price: 5000 },
                                    { name: '250サイズ (8600円)', price: 8600 },
                                    { name: '300サイズ (12000円)', price: 12000 },
                                    { name: '350サイズ (18500円)', price: 18500 },
                                    { name: '400サイズ (25400円)', price: 25400 },
                                    { name: '450サイズ (33000円)', price: 33000 },
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                id: 'mercari',
                name: 'メルカリ',
                feeRate: 0.10,
                feeType: 'percent',
                color: 'bg-red-500',
                borderHex: '#ef4444',
                shippingUrl: 'https://help.jp.mercari.com/guide/categories/1424/',
                supportsBuyerShipping: true,
                shippingCategories: [
                    {
                        name: 'らくらくメルカリ便（ヤマト運輸）',
                        methods: [
                            { name: 'ネコポス', sizes: [{ name: '全国一律', price: 210 }] },
                            { name: '宅急便コンパクト', sizes: [{ name: '全国一律', price: 450 }] },
                            {
                                name: '宅急便',
                                sizes: [
                                    { name: '60サイズ (2kgまで)', price: 750 },
                                    { name: '80サイズ (5kgまで)', price: 850 },
                                    { name: '100サイズ (10kgまで)', price: 1050 },
                                    { name: '120サイズ (15kgまで)', price: 1200 },
                                    { name: '140サイズ (20kgまで)', price: 1450 },
                                    { name: '160サイズ (25kgまで)', price: 1700 },
                                    { name: '180サイズ (30kgまで)', price: 2100 },
                                    { name: '200サイズ (30kgまで)', price: 2500 },
                                ]
                            },
                        ]
                    },
                    {
                        name: 'ゆうゆうメルカリ便（日本郵便）',
                        methods: [
                            { name: 'ゆうパケット', sizes: [{ name: '全国一律 (1kgまで)', price: 230 }] },
                            { name: 'ゆうパケットポスト', sizes: [{ name: '全国一律 (2kgまで)', price: 215 }] },
                            { name: 'ゆうパケットポストmini', sizes: [{ name: '全国一律', price: 160 }] },
                            { name: 'ゆうパケットプラス', sizes: [{ name: '全国一律 (2kgまで)', price: 455 }] },
                            {
                                name: 'ゆうパック',
                                sizes: [
                                    { name: '60サイズ (25kgまで)', price: 770 },
                                    { name: '80サイズ (25kgまで)', price: 870 },
                                    { name: '100サイズ (25kgまで)', price: 1070 },
                                    { name: '120サイズ (25kgまで)', price: 1200 },
                                    { name: '140サイズ (25kgまで)', price: 1450 },
                                    { name: '160サイズ (25kgまで)', price: 1700 },
                                    { name: '170サイズ (25kgまで)', price: 1900 },
                                ]
                            },
                        ]
                    },
                    {
                        name: 'エコメルカリ便（置き配限定）',
                        methods: [
                            { name: 'エコメルカリ便', sizes: [{ name: '100サイズまで一律', price: 730 }] }
                        ]
                    },
                    {
                        name: '梱包・発送たのメル便',
                        methods: [
                            {
                                name: '大型家具・家電',
                                sizes: [
                                    { name: '80サイズ', price: 1700 },
                                    { name: '120サイズ', price: 2400 },
                                    { name: '160サイズ', price: 3400 },
                                    { name: '200サイズ', price: 5000 },
                                    { name: '250サイズ', price: 8600 },
                                    { name: '300サイズ', price: 12000 },
                                    { name: '350サイズ', price: 18500 },
                                    { name: '400サイズ', price: 25400 },
                                    { name: '450サイズ', price: 33000 },
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                id: 'rakuma',
                name: 'ラクマ',
                feeRate: 0.06,
                feeType: 'percent',
                color: 'bg-blue-500',
                borderHex: '#3b82f6',
                shippingUrl: 'https://fril.jp/ts/kantanrakumapack/#merit01',
                supportsBuyerShipping: true,
                feeTiers: [
                    { label: '4.5%（楽天モバイル利用）', rate: 4.5 },
                    { label: '6%（標準）', rate: 6 },
                    { label: '7%', rate: 7 },
                    { label: '8%', rate: 8 },
                    { label: '9%', rate: 9 },
                    { label: '10%（初期）', rate: 10 },
                ],
                shippingCategories: [
                    {
                        name: 'かんたんラクマパック（日本郵便）',
                        methods: [
                            { name: 'ゆうパケット', sizes: [{ name: '全国一律', price: 180 }] },
                            { name: 'ゆうパケットポスト', sizes: [{ name: '全国一律', price: 175 }] },
                            { name: 'ゆうパケットポストmini', sizes: [{ name: '全国一律', price: 160 }] },
                            { name: 'ゆうパケットプラス', sizes: [{ name: '全国一律', price: 380 }] },
                            {
                                name: 'ゆうパック',
                                sizes: [
                                    { name: '60サイズ', price: 700 },
                                    { name: '80サイズ', price: 800 },
                                    { name: '100サイズ', price: 1000 },
                                    { name: '120サイズ', price: 1200 },
                                    { name: '140サイズ', price: 1450 },
                                    { name: '160サイズ', price: 1500 },
                                    { name: '170サイズ', price: 1500 },
                                ]
                            },
                        ]
                    },
                    {
                        name: 'かんたんラクマパック（ヤマト運輸）',
                        methods: [
                            { name: 'ネコポス', sizes: [{ name: '全国一律', price: 200 }] },
                            { name: '宅急便コンパクト', sizes: [{ name: '全国一律', price: 530 }] },
                            {
                                name: '宅急便',
                                sizes: [
                                    { name: '60サイズ', price: 800 },
                                    { name: '80サイズ', price: 900 },
                                    { name: '100サイズ', price: 1150 },
                                    { name: '120サイズ', price: 1350 },
                                    { name: '140サイズ', price: 1550 },
                                    { name: '160サイズ', price: 1700 },
                                    { name: '180サイズ', price: 2100 },
                                    { name: '200サイズ', price: 2500 },
                                ]
                            },
                        ]
                    }
                ]
            },
        ];

        // --- Helper Functions ---

        const calculateSellPrice = (targetProfit, shipping, feeRate) => {
            if (feeRate >= 1) return 0;
            let tempPrice = Math.ceil((targetProfit + shipping) / (1 - feeRate));
            const calcProfit = (p) => p - Math.floor(p * feeRate) - shipping;

            while (calcProfit(tempPrice) < targetProfit) {
                tempPrice++;
            }
            while (calcProfit(tempPrice - 1) >= targetProfit) {
                tempPrice--;
            }
            return tempPrice;
        };

        const calculateProfit = (sellPrice, shipping, feeRate) => {
            const fee = Math.floor(sellPrice * feeRate);
            return sellPrice - fee - shipping;
        };

        // --- Main Component ---

        function FleaMarketCalculator() {
            const [selectedPlatformId, setSelectedPlatformId] = useState('yahoo');
            const [feeRatePercent, setFeeRatePercent] = useState(5);
            const [mode, setMode] = useState('targetProfit');
            const [inputValue, setInputValue] = useState(1000);
            const [maxQuantity, setMaxQuantity] = useState(1);

            const [basicCategoryIndex, setBasicCategoryIndex] = useState(0);
            const [basicMethodIndex, setBasicMethodIndex] = useState(0);
            const [basicSizeIndex, setBasicSizeIndex] = useState(0);
            const [basicCustomCost, setBasicCustomCost] = useState(0);
            const [isBasicCustom, setIsBasicCustom] = useState(false);
            const [isBuyerShipping, setIsBuyerShipping] = useState(false);

            const [isAdvancedMode, setIsAdvancedMode] = useState(false);
            const [shippingRanges, setShippingRanges] = useState([]);

            const currentPlatform = PLATFORMS.find(p => p.id === selectedPlatformId);

            useEffect(() => {
                if (currentPlatform) {
                    setFeeRatePercent(currentPlatform.feeRate * 100);
                    setBasicCategoryIndex(0);
                    setBasicMethodIndex(0);
                    setBasicSizeIndex(0);
                    setIsBasicCustom(false);
                    setIsBuyerShipping(false);
                    setIsAdvancedMode(false);
                    setShippingRanges([]);
                }
            }, [selectedPlatformId]);

            const currentBasicShippingCost = useMemo(() => {
                if (isBuyerShipping) return 0;
                if (isBasicCustom) return basicCustomCost;
                const cat = currentPlatform?.shippingCategories[basicCategoryIndex];
                const method = cat?.methods[basicMethodIndex];
                const size = method?.sizes[basicSizeIndex];
                return size?.price || 0;
            }, [currentPlatform, basicCategoryIndex, basicMethodIndex, basicSizeIndex, isBasicCustom, basicCustomCost, isBuyerShipping]);

            useEffect(() => {
                if (isAdvancedMode && shippingRanges.length === 0) {
                    setShippingRanges([{
                        id: crypto.randomUUID(),
                        min: 1,
                        max: maxQuantity,
                        categoryIndex: basicCategoryIndex,
                        methodIndex: basicMethodIndex,
                        sizeIndex: basicSizeIndex,
                        isCustom: isBasicCustom,
                        customCost: basicCustomCost
                    }]);
                } else if (isAdvancedMode && shippingRanges.length > 0) {
                    const lastRange = shippingRanges[shippingRanges.length - 1];
                    if (lastRange.max !== maxQuantity) {
                        const updated = [...shippingRanges];
                        updated[updated.length - 1] = { ...lastRange, max: maxQuantity };

                        if (updated.some(r => r.min > maxQuantity)) {
                            setShippingRanges([{
                                id: crypto.randomUUID(),
                                min: 1,
                                max: maxQuantity,
                                categoryIndex: basicCategoryIndex,
                                methodIndex: basicMethodIndex,
                                sizeIndex: basicSizeIndex,
                                isCustom: isBasicCustom,
                                customCost: basicCustomCost
                            }]);
                        } else {
                            setShippingRanges(updated);
                        }
                    }
                }
            }, [isAdvancedMode, maxQuantity]);

            const splitRange = (index) => {
                const range = shippingRanges[index];
                if (range.max - range.min < 1) return;

                const mid = Math.floor((range.min + range.max) / 2);

                const newLeft = { ...range, max: mid };
                const newRight = {
                    ...range,
                    id: crypto.randomUUID(),
                    min: mid + 1,
                };

                const newRanges = [...shippingRanges];
                newRanges[index] = newLeft;
                newRanges.splice(index + 1, 0, newRight);
                setShippingRanges(newRanges);
            };

            const removeRange = (index) => {
                if (shippingRanges.length <= 1) return;
                const newRanges = [...shippingRanges];
                const removed = newRanges.splice(index, 1)[0];

                if (index === 0) {
                    newRanges[0].min = 1;
                } else {
                    newRanges[index - 1].max = removed.max;
                }
                setShippingRanges(newRanges);
            };

            const updateRangeMax = (index, newMax) => {
                if (index === shippingRanges.length - 1) return;
                const range = shippingRanges[index];
                const nextRange = shippingRanges[index + 1];

                if (newMax < range.min || newMax >= nextRange.max) return;

                const newRanges = [...shippingRanges];
                newRanges[index].max = newMax;
                newRanges[index + 1].min = newMax + 1;
                setShippingRanges(newRanges);
            };

            const updateRangeSetting = (index, field, value) => {
                const newRanges = [...shippingRanges];
                newRanges[index] = { ...newRanges[index], [field]: value };

                if (field === 'categoryIndex') {
                    newRanges[index].methodIndex = 0;
                    newRanges[index].sizeIndex = 0;
                }
                if (field === 'methodIndex') {
                    newRanges[index].sizeIndex = 0;
                }
                setShippingRanges(newRanges);
            };

            const calculationResults = useMemo(() => {
                const results = [];
                const feeRate = feeRatePercent / 100;

                for (let qty = 1; qty <= Math.max(1, maxQuantity); qty++) {
                    let shipping = 0;

                    if (isBuyerShipping) {
                        shipping = 0;
                    } else if (isAdvancedMode) {
                        const range = shippingRanges.find(r => qty >= r.min && qty <= r.max);
                        if (range) {
                            if (range.isCustom) {
                                shipping = range.customCost;
                            } else {
                                const cat = currentPlatform?.shippingCategories[range.categoryIndex];
                                const method = cat?.methods[range.methodIndex];
                                const size = method?.sizes[range.sizeIndex];
                                shipping = size?.price || 0;
                            }
                        }
                    } else {
                        shipping = currentBasicShippingCost;
                    }

                    let result = {
                        quantity: qty,
                        sellPrice: 0,
                        profit: 0,
                        fee: 0,
                        shipping: shipping,
                        unitPrice: 0,
                        unitProfit: 0
                    };

                    if (mode === 'targetProfit') {
                        const totalTargetProfit = inputValue * qty;
                        result.profit = totalTargetProfit;
                        result.sellPrice = calculateSellPrice(totalTargetProfit, shipping, feeRate);
                        result.fee = Math.floor(result.sellPrice * feeRate);
                        result.unitPrice = Math.round(result.sellPrice / qty);
                        result.unitProfit = inputValue;
                    } else {
                        const totalSellPrice = inputValue * qty;
                        result.sellPrice = totalSellPrice;
                        result.profit = calculateProfit(totalSellPrice, shipping, feeRate);
                        result.fee = Math.floor(totalSellPrice * feeRate);
                        result.unitPrice = inputValue;
                        result.unitProfit = Math.round(result.profit / qty);
                    }
                    results.push(result);
                }
                return results;
            }, [inputValue, feeRatePercent, mode, maxQuantity, isAdvancedMode, shippingRanges, currentBasicShippingCost, currentPlatform, isBuyerShipping]);

            const mainResult = calculationResults[0];

            return (
                <div className="max-w-4xl mx-auto p-4 md:p-6 bg-slate-50 min-h-screen font-sans text-slate-800">

                    {/* Header */}
                    <header className="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h1 className="text-2xl font-bold flex items-center gap-2 text-slate-800">
                                <Calculator className="w-6 h-6 text-indigo-600" />
                                フリマ設定価格計算ツール
                            </h1>
                            <p className="text-sm text-slate-500 mt-1">手数料・送料を考慮して利益や価格を自動計算</p>
                        </div>
                    </header>

                    {/* Settings Card */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 mb-6">

                        {/* Platform Selection */}
                        <div className="mb-6">
                            <label className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2 block">
                                STEP 0: プラットフォーム選択
                            </label>
                            <div className="flex flex-wrap gap-2">
                                {PLATFORMS.map(p => (
                                    <button
                                        key={p.id}
                                        onClick={() => setSelectedPlatformId(p.id)}
                                        className={`px-4 py-3 rounded-lg text-sm font-bold transition-all border-2 flex items-center gap-2 ${selectedPlatformId === p.id
                                            ? 'bg-slate-50 text-slate-900'
                                            : 'border-transparent bg-slate-100 text-slate-500 hover:bg-slate-200'
                                            }`}
                                        style={{ borderColor: selectedPlatformId === p.id ? p.borderHex : 'transparent' }}
                                    >
                                        <span className={`inline-block w-3 h-3 rounded-full ${p.color}`}></span>
                                        {p.name}
                                    </button>
                                ))}
                            </div>
                            {/* Fee Rate Input */}
                            <div className="flex items-center gap-2 mt-3 flex-wrap">
                                <label className="text-xs text-slate-500">販売手数料 (%):</label>
                                {currentPlatform?.feeTiers && (
                                    <select
                                        value={currentPlatform.feeTiers.find(t => t.rate === feeRatePercent) ? feeRatePercent : ''}
                                        onChange={(e) => setFeeRatePercent(parseFloat(e.target.value))}
                                        className="px-2 py-1 text-sm border rounded bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    >
                                        {!currentPlatform.feeTiers.find(t => t.rate === feeRatePercent) && (
                                            <option value="" disabled>カスタム ({feeRatePercent}%)</option>
                                        )}
                                        {currentPlatform.feeTiers.map((tier, idx) => (
                                            <option key={idx} value={tier.rate}>{tier.label}</option>
                                        ))}
                                    </select>
                                )}
                                <input
                                    type="number"
                                    value={feeRatePercent}
                                    onChange={(e) => setFeeRatePercent(parseFloat(e.target.value))}
                                    className="w-20 px-2 py-1 text-sm border rounded bg-slate-50 text-right focus:ring-2 focus:ring-indigo-500 outline-none"
                                />
                            </div>
                        </div>

                        {/* Basic Shipping Selection */}
                        {!isAdvancedMode && (
                            <div className="space-y-4 pt-4 border-t border-slate-100">
                                <div className="flex justify-between items-center">
                                    <label className="text-sm font-bold text-slate-700 flex items-center gap-2">
                                        <Truck className="w-4 h-4 text-indigo-500" /> 配送方法の設定 (基本)
                                    </label>
                                    {currentPlatform && (
                                        <a
                                            href={currentPlatform.shippingUrl}
                                            target="_blank"
                                            rel="noreferrer"
                                            className="text-xs text-indigo-600 flex items-center gap-0.5 hover:underline"
                                        >
                                            {currentPlatform.name}送料表 <ExternalLink className="w-3 h-3" />
                                        </a>
                                    )}
                                </div>

                                {/* Buyer-paid shipping toggle */}
                                {currentPlatform?.supportsBuyerShipping && (
                                    <div className="p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                        <div className="flex items-center gap-4">
                                            <span className="text-sm font-semibold text-slate-700">送料負担:</span>
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input
                                                    type="radio"
                                                    name="shippingBurden"
                                                    checked={!isBuyerShipping}
                                                    onChange={() => setIsBuyerShipping(false)}
                                                    className="text-indigo-600 focus:ring-indigo-500"
                                                />
                                                <span className="text-sm text-slate-700">出品者負担（送料込み）</span>
                                            </label>
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input
                                                    type="radio"
                                                    name="shippingBurden"
                                                    checked={isBuyerShipping}
                                                    onChange={() => setIsBuyerShipping(true)}
                                                    className="text-indigo-600 focus:ring-indigo-500"
                                                />
                                                <span className="text-sm text-slate-700">購入者負担（着払い）</span>
                                            </label>
                                        </div>
                                        {isBuyerShipping && (
                                            <p className="text-xs text-amber-700 mt-2 flex items-center gap-1">
                                                <Info className="w-3 h-3 flex-shrink-0" />
                                                着払いの場合、匿名配送（{currentPlatform.id === 'mercari' ? 'らくらくメルカリ便・ゆうゆうメルカリ便' : 'かんたんラクマパック'}）は利用できません。送料は購入者が支払うため、利益計算では送料0円として計算します。
                                            </p>
                                        )}
                                    </div>
                                )}

                                {!isBuyerShipping && (
                                    <>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div className="space-y-1">
                                                <label className="text-xs font-semibold text-slate-500">1. 配送サービス種別</label>
                                                <select
                                                    className="w-full p-2.5 text-sm border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 outline-none"
                                                    value={basicCategoryIndex}
                                                    disabled={isBasicCustom}
                                                    onChange={(e) => {
                                                        setBasicCategoryIndex(Number(e.target.value));
                                                        setBasicMethodIndex(0);
                                                        setBasicSizeIndex(0);
                                                    }}
                                                >
                                                    {currentPlatform?.shippingCategories.map((cat, idx) => (
                                                        <option key={idx} value={idx}>{cat.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-xs font-semibold text-slate-500 flex items-center gap-1">
                                                    <ChevronRight className="w-3 h-3 text-slate-400" /> 2. 配送方法
                                                </label>
                                                <select
                                                    className="w-full p-2.5 text-sm border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 outline-none"
                                                    value={basicMethodIndex}
                                                    disabled={isBasicCustom}
                                                    onChange={(e) => {
                                                        setBasicMethodIndex(Number(e.target.value));
                                                        setBasicSizeIndex(0);
                                                    }}
                                                >
                                                    {currentPlatform?.shippingCategories[basicCategoryIndex]?.methods.map((method, idx) => (
                                                        <option key={idx} value={idx}>{method.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-xs font-semibold text-slate-500 flex items-center gap-1">
                                                    <ChevronRight className="w-3 h-3 text-slate-400" /> 3. サイズ・詳細
                                                </label>
                                                <select
                                                    className="w-full p-2.5 text-sm border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 outline-none"
                                                    value={basicSizeIndex}
                                                    disabled={isBasicCustom}
                                                    onChange={(e) => setBasicSizeIndex(Number(e.target.value))}
                                                >
                                                    {currentPlatform?.shippingCategories[basicCategoryIndex]?.methods[basicMethodIndex]?.sizes.map((size, idx) => (
                                                        <option key={idx} value={idx}>
                                                            {size.name} ({size.price}円)
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>

                                        <div className="flex items-center justify-end gap-4 mt-2 bg-slate-50 p-3 rounded-lg">
                                            <label className="flex items-center gap-2 text-sm text-slate-600 cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={isBasicCustom}
                                                    onChange={(e) => setIsBasicCustom(e.target.checked)}
                                                    className="rounded text-indigo-600 focus:ring-indigo-500"
                                                />
                                                送料を手入力する (その他)
                                            </label>
                                            <div className={`flex items-center gap-2 transition-opacity ${isBasicCustom ? 'opacity-100' : 'opacity-50'}`}>
                                                <span className="text-xs font-bold text-slate-500">送料:</span>
                                                <input
                                                    type="number"
                                                    value={basicCustomCost}
                                                    disabled={!isBasicCustom}
                                                    onChange={(e) => setBasicCustomCost(parseInt(e.target.value) || 0)}
                                                    className="w-24 px-2 py-1 text-sm border rounded bg-white text-right font-mono font-medium focus:ring-2 focus:ring-indigo-500 outline-none"
                                                />
                                                <span className="text-xs text-slate-500">円</span>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {isAdvancedMode && (
                            <div className="pt-4 border-t border-slate-100">
                                <div className="p-3 bg-indigo-50 text-indigo-700 text-sm rounded mb-4 flex gap-2">
                                    <Info className="w-5 h-5 flex-shrink-0" />
                                    <div>
                                        <strong>詳細設定モードが有効です</strong><br />
                                        下の「まとめ売りシミュレーション」エリアで、個数範囲ごとの送料を設定してください。
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Calculation Inputs */}
                    <div className="bg-white rounded-xl shadow-lg border border-indigo-100 p-6 mb-6 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>

                        <div className="flex flex-col md:flex-row gap-8 items-start">

                            {/* Mode Switcher & Input */}
                            <div className="flex-1 w-full">
                                <div className="flex bg-slate-100 p-1 rounded-lg mb-4">
                                    <button
                                        onClick={() => setMode('targetProfit')}
                                        className={`flex-1 py-2 px-4 rounded-md text-sm font-bold transition-all flex items-center justify-center gap-2 ${mode === 'targetProfit'
                                            ? 'bg-white text-indigo-700 shadow-sm'
                                            : 'text-slate-500 hover:text-slate-700'
                                            }`}
                                    >
                                        <Coins className="w-4 h-4" /> 欲しい利益から計算
                                    </button>
                                    <button
                                        onClick={() => setMode('targetPrice')}
                                        className={`flex-1 py-2 px-4 rounded-md text-sm font-bold transition-all flex items-center justify-center gap-2 ${mode === 'targetPrice'
                                            ? 'bg-white text-emerald-700 shadow-sm'
                                            : 'text-slate-500 hover:text-slate-700'
                                            }`}
                                    >
                                        <TrendingUp className="w-4 h-4" /> 設定価格から計算
                                    </button>
                                </div>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-1">
                                            {mode === 'targetProfit' ? '1個あたり 手元に残したい金額' : '1個あたり 設定したい販売価格'}
                                        </label>
                                        <div className="relative">
                                            <input
                                                type="number"
                                                value={inputValue}
                                                onChange={(e) => setInputValue(parseInt(e.target.value) || 0)}
                                                className={`w-full text-3xl font-bold p-3 border rounded-xl outline-none focus:ring-2 pr-12 text-right ${mode === 'targetProfit' ? 'text-indigo-600 border-indigo-200 focus:ring-indigo-500' : 'text-emerald-600 border-emerald-200 focus:ring-emerald-500'
                                                    }`}
                                            />
                                            <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">円</span>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold text-slate-700 mb-1">
                                            シミュレーション個数 (セット売り等)
                                        </label>
                                        <div className="flex items-center gap-4">
                                            <input
                                                type="range"
                                                min="1"
                                                max="10"
                                                value={maxQuantity}
                                                onChange={(e) => setMaxQuantity(parseInt(e.target.value))}
                                                className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                                            />
                                            <div className="w-16 border rounded bg-white px-2 py-1 text-center font-bold">
                                                {maxQuantity}個
                                            </div>
                                        </div>
                                        <p className="text-xs text-slate-500 mt-1">※最大10個まで表示。個数を増やすと「まとめ売り」時の単価変動を確認できます。</p>
                                    </div>
                                </div>
                            </div>

                            {/* Main Single Result (1 Unit) */}
                            <div className="w-full md:w-5/12 bg-slate-50 rounded-xl p-5 border border-slate-200">
                                <h3 className="text-center font-bold text-slate-500 mb-4">1個 出品する場合</h3>

                                {mode === 'targetProfit' ? (
                                    <div className="text-center">
                                        <div className="text-sm text-slate-500 mb-1">設定すべき販売価格</div>
                                        <div className="text-4xl font-extrabold text-indigo-600 mb-4">
                                            &yen;{mainResult.sellPrice.toLocaleString()}
                                        </div>
                                        <div className="space-y-2 text-sm border-t border-slate-200 pt-3">
                                            <div className="flex justify-between">
                                                <span className="text-slate-500">手数料 ({feeRatePercent}%)</span>
                                                <span className="font-mono">-&yen;{mainResult.fee.toLocaleString()}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-slate-500">送料</span>
                                                <span className="font-mono">
                                                    {isBuyerShipping
                                                        ? <span className="text-amber-600 text-xs font-bold">購入者負担</span>
                                                        : <>-&yen;{mainResult.shipping.toLocaleString()}</>
                                                    }
                                                </span>
                                            </div>
                                            <div className="flex justify-between font-bold text-slate-700 pt-2 border-t border-dashed border-slate-300">
                                                <span>利益 (手残り)</span>
                                                <span>&yen;{mainResult.profit.toLocaleString()}</span>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center">
                                        <div className="text-sm text-slate-500 mb-1">手元に残る利益</div>
                                        <div className="text-4xl font-extrabold text-emerald-600 mb-4">
                                            &yen;{mainResult.profit.toLocaleString()}
                                        </div>
                                        <div className="space-y-2 text-sm border-t border-slate-200 pt-3">
                                            <div className="flex justify-between">
                                                <span className="text-slate-500">販売価格</span>
                                                <span className="font-mono">&yen;{mainResult.sellPrice.toLocaleString()}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-slate-500">手数料 ({feeRatePercent}%)</span>
                                                <span className="font-mono text-red-500">-&yen;{mainResult.fee.toLocaleString()}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-slate-500">送料</span>
                                                <span className={`font-mono ${!isBuyerShipping ? 'text-red-500' : ''}`}>
                                                    {isBuyerShipping
                                                        ? <span className="text-amber-600 text-xs font-bold">購入者負担</span>
                                                        : <>-&yen;{mainResult.shipping.toLocaleString()}</>
                                                    }
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                        </div>
                    </div>

                    {/* Multi-unit Table & Advanced Settings */}
                    {maxQuantity > 1 && (
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden relative">

                            <div className="p-4 bg-slate-50 border-b border-slate-200 flex flex-wrap items-center justify-between gap-2">
                                <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                    <ArrowRightLeft className="w-5 h-5 text-indigo-500" />
                                    まとめ売りシミュレーション
                                </h3>

                                <button
                                    onClick={() => setIsAdvancedMode(!isAdvancedMode)}
                                    className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${isAdvancedMode
                                        ? 'bg-indigo-600 text-white border-indigo-600 hover:bg-indigo-700'
                                        : 'bg-white text-slate-500 border-slate-300 hover:bg-slate-50'
                                        }`}
                                >
                                    <Settings className="w-3 h-3" />
                                    {isAdvancedMode ? '詳細設定: ON' : '詳細設定 (個数ごとの送料)'}
                                </button>
                            </div>

                            {/* Advanced Mode Settings Panel */}
                            {isAdvancedMode && (
                                <div className="p-4 bg-indigo-50/50 border-b border-indigo-100 space-y-4">
                                    <div className="flex items-center justify-between">
                                        <h4 className="text-xs font-bold text-indigo-800 uppercase tracking-wider">個数ごとの送料範囲設定</h4>
                                        <div className="text-xs text-indigo-600">※個数が増えると送料が変わる場合に設定</div>
                                    </div>

                                    <div className="space-y-3">
                                        {shippingRanges.map((range, idx) => (
                                            <div key={range.id} className="bg-white p-3 rounded-lg border border-indigo-200 shadow-sm relative">
                                                <div className="flex flex-col md:flex-row gap-4 items-start md:items-center mb-3">
                                                    <div className="flex items-center gap-2 min-w-[140px]">
                                                        <div className="bg-slate-100 px-2 py-1 rounded text-sm font-bold text-slate-600">
                                                            {range.min}個 〜
                                                        </div>
                                                        <select
                                                            className="bg-white border border-slate-300 rounded px-2 py-1 text-sm font-bold focus:ring-2 focus:ring-indigo-500 outline-none"
                                                            value={range.max}
                                                            onChange={(e) => updateRangeMax(idx, Number(e.target.value))}
                                                            disabled={idx === shippingRanges.length - 1}
                                                        >
                                                            {Array.from({ length: maxQuantity - range.min + 1 }, (_, i) => range.min + i).map(n => (
                                                                <option key={n} value={n}>{n}個</option>
                                                            ))}
                                                        </select>
                                                    </div>

                                                    <div className="flex items-center gap-2 ml-auto">
                                                        {idx < shippingRanges.length && (range.max - range.min >= 1) && (
                                                            <button
                                                                onClick={() => splitRange(idx)}
                                                                className="text-xs flex items-center gap-1 bg-indigo-50 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-100 transition-colors"
                                                                title="この範囲を分割して追加"
                                                            >
                                                                <Plus className="w-3 h-3" /> 分割
                                                            </button>
                                                        )}
                                                        {shippingRanges.length > 1 && (
                                                            <button
                                                                onClick={() => removeRange(idx)}
                                                                className="text-xs flex items-center gap-1 bg-red-50 text-red-500 px-2 py-1 rounded hover:bg-red-100 transition-colors"
                                                                title="この範囲を削除して結合"
                                                            >
                                                                <Trash2 className="w-3 h-3" />
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
                                                    <select
                                                        className="p-1.5 border rounded"
                                                        value={range.categoryIndex}
                                                        onChange={(e) => updateRangeSetting(idx, 'categoryIndex', Number(e.target.value))}
                                                        disabled={range.isCustom}
                                                    >
                                                        {currentPlatform?.shippingCategories.map((cat, i) => (
                                                            <option key={i} value={i}>{cat.name}</option>
                                                        ))}
                                                    </select>
                                                    <select
                                                        className="p-1.5 border rounded"
                                                        value={range.methodIndex}
                                                        onChange={(e) => updateRangeSetting(idx, 'methodIndex', Number(e.target.value))}
                                                        disabled={range.isCustom}
                                                    >
                                                        {currentPlatform?.shippingCategories[range.categoryIndex]?.methods.map((m, i) => (
                                                            <option key={i} value={i}>{m.name}</option>
                                                        ))}
                                                    </select>
                                                    <select
                                                        className="p-1.5 border rounded"
                                                        value={range.sizeIndex}
                                                        onChange={(e) => updateRangeSetting(idx, 'sizeIndex', Number(e.target.value))}
                                                        disabled={range.isCustom}
                                                    >
                                                        {currentPlatform?.shippingCategories[range.categoryIndex]?.methods[range.methodIndex]?.sizes.map((s, i) => (
                                                            <option key={i} value={i}>{s.name} ({s.price}円)</option>
                                                        ))}
                                                    </select>
                                                </div>

                                                <div className="mt-2 flex items-center justify-end gap-2 text-xs">
                                                    <label className="flex items-center gap-1 cursor-pointer">
                                                        <input
                                                            type="checkbox"
                                                            checked={range.isCustom}
                                                            onChange={(e) => updateRangeSetting(idx, 'isCustom', e.target.checked)}
                                                            className="rounded text-indigo-600"
                                                        />
                                                        <span>カスタム送料</span>
                                                    </label>
                                                    {range.isCustom && (
                                                        <input
                                                            type="number"
                                                            className="w-16 border rounded px-1 text-right"
                                                            value={range.customCost}
                                                            onChange={(e) => updateRangeSetting(idx, 'customCost', parseInt(e.target.value) || 0)}
                                                        />
                                                    )}
                                                </div>

                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Table */}
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                                        <tr>
                                            <th className="px-6 py-3">個数</th>
                                            <th className="px-6 py-3 text-right">送料 (適用)</th>
                                            <th className="px-6 py-3 text-right text-indigo-600">設定総額(円)</th>
                                            <th className="px-6 py-3 text-right">単価(円)</th>
                                            <th className="px-6 py-3 text-right text-emerald-600">総利益(円)</th>
                                            <th className="px-6 py-3 text-right">1個あたり利益</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {calculationResults.map((row) => (
                                            <tr key={row.quantity} className="bg-white border-b hover:bg-slate-50 transition-colors">
                                                <td className="px-6 py-4 font-bold">{row.quantity}個</td>
                                                <td className="px-6 py-4 text-right text-slate-500 text-xs">
                                                    {isBuyerShipping
                                                        ? <span className="text-amber-600 font-bold">購入者負担</span>
                                                        : <>-&yen;{row.shipping.toLocaleString()}</>
                                                    }
                                                </td>
                                                <td className="px-6 py-4 text-right font-bold text-indigo-700 text-base">
                                                    &yen;{row.sellPrice.toLocaleString()}
                                                </td>
                                                <td className="px-6 py-4 text-right font-mono text-slate-600">
                                                    @&yen;{row.unitPrice.toLocaleString()}
                                                </td>
                                                <td className="px-6 py-4 text-right font-bold text-emerald-700 text-base">
                                                    &yen;{row.profit.toLocaleString()}
                                                </td>
                                                <td className="px-6 py-4 text-right font-mono text-slate-600">
                                                    @&yen;{row.unitProfit.toLocaleString()}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            <div className="p-4 text-xs text-slate-400 flex items-start gap-2">
                                <Info className="w-4 h-4 shrink-0" />
                                <p>
                                    {isBuyerShipping
                                        ? '※送料は購入者負担（着払い）のため、送料0円で計算しています。'
                                        : !isAdvancedMode
                                            ? `※現在の設定では、個数に関わらず一律「${currentBasicShippingCost}円」の送料で計算しています。サイズが変わる場合は「詳細設定」ボタンを押してください。`
                                            : '※個数範囲ごとに設定された送料が適用されています。'
                                    }
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- Render ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FleaMarketCalculator />);
    </script>
</body>

</html>