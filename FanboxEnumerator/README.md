# FANBOX支援者リスト抽出ツール

**ツールURL:** (GitHub Pagesで公開後に記載 - 例: `https://kiyo.bio/Tools/FanboxEnumerator/`)

## 1. ユーザー向け説明

このツールは、Pixiv FANBOXのクリエイター向け「ファン一覧」ページ (`https://*.fanbox.cc/manage/relationships`) から支援者の情報を抽出し、CSVまたはJSON形式でダウンロードするためのクライアントサイドウェブアプリケーションです。
手動でのデータ収集・転記作業を効率化し、抽出したデータを他のツールやスプレッドシートでの管理に利用しやすくすることを目的としています。

### 1.1. 主な機能

* **HTMLソースからの情報抽出:**
    * 指定されたFANBOX支援者一覧ページのURLからHTMLソースを読み込み（プロキシ経由）、または手動で貼り付けられたHTMLソースを解析します。
    * 以下の情報を抽出します:
        * 支援者名
        * 支援者のPixivユーザーID
        * 支援中プラン名
        * 支援開始日
        * クリエイターが設定したメモ
* **データプレビュー:** 抽出した情報をテーブル形式で画面に表示します。
* **フィルタリング:**
    * **プランフィルター:** 特定のプラン（複数選択可）の支援者のみを表示します。
    * **支援期間フィルター:** 指定した日付以降/以前に支援を開始したユーザー、または指定した月数以上継続しているユーザーで絞り込めます。
* **ソート:** プレビューテーブルの各列（支援者名、ユーザーID、プラン名、支援開始日、メモ）で昇順・降順にソートできます。
* **エクスポート:** フィルタリング・ソート後のデータをCSVまたはJSON形式でダウンロードできます。
* **URLクエリパラメータ対応:** URLにパラメータを指定することで、ページの読み込みと同時にHTML取得、フィルタリング、ソート、自動ダウンロードまでを実行できます（自動化連携用）。

### 1.2. 具体的な使い方

1.  **入力方法の選択:**
    * 「URLから読み込む」または「HTMLを直接入力」のラジオボタンを選択します。
2.  **FANBOX情報の入力:**
    * **URLから読み込む場合:**
        1.  「プロキシサーバー」を選択します（通常はデフォルトの「Proxy 1 (codetabs)」で問題ありません。読み込めない場合は他のプロキシを試してください）。
        2.  「FanboxクリエイターID」入力欄にあなたのクリエイターID（例: `yourcreatorid`）を入力するか、または「フルURL」入力欄に支援者一覧ページの完全なURL（例: `https://yourcreatorid.fanbox.cc/manage/relationships`）を入力します。
        3.  「HTML読み込み＆解析実行」ボタンを押します。ステータスメッセージに進捗が表示されます。
    * **HTMLを直接入力する場合:**
        1.  お使いのブラウザでご自身のFANBOX支援者一覧ページを開きます。
        2.  ページ全体、または少なくとも支援者リストが表示されている範囲のHTMLソースコードをコピーします。（ブラウザの開発者ツールなどでHTML要素を選択しコピーするのが確実です。）
        3.  ツールページの「HTMLソース直接入力」テキストエリアに、コピーしたHTMLソースを貼り付けます。
        4.  「HTML解析実行」ボタンを押します。
3.  **フィルタリングとソート (任意):**
    * HTMLの解析が成功すると、「抽出結果と操作」セクションが表示されます。
    * **プランフィルター:** 表示されたプラン名のチェックボックスで、表示したいプランを選択（複数可）します。チェックを変更すると自動でプレビューが更新されます。
    * **支援期間フィルター:**
        * 「支援開始日 (以降/以前)」: カレンダーから日付を選択します。
        * 「継続月数 (以上)」: 数値を入力します。
        * 入力後、「フィルター適用」ボタンを押すとプレビューが更新されます。「フィルターリセット」で解除できます。
    * **ソート:** プレビューテーブルのヘッダー（支援者名、ユーザーIDなど）をクリックすると、その列を基準に昇順/降順でソートされます。
4.  **データのエクスポート:**
    * 「出力形式」ドロップダウンからCSVまたはJSONを選択します。
    * 「ダウンロード」ボタンを押すと、現在プレビューに表示されているデータ（フィルタリング・ソート適用後）が選択した形式でダウンロードされます。

### 1.3. URLクエリパラメータによる自動操作

このツールは、URLのクエリパラメータを使って、ページを開くと同時に特定の一連の操作を自動的に行うことができます。これは、他のスクリプトやブックマークレットから定期的にデータを取得するような自動化処理に便利です。

**指定可能なクエリパラメータ:**

* `creator_id=[あなたのFanboxクリエイターID]` : (必須、または`url`を指定) FanboxのクリエイターID。例: `yourcreatorid`
* `url=[Fanbox支援者一覧ページのフルURL]` : (必須、または`creator_id`を指定) 例: `https://yourcreatorid.fanbox.cc/manage/relationships`
    * `creator_id` と `url` が両方指定された場合は `url` が優先されます。
    * **セキュリティ注意:** `url`パラメータで指定できるのは `*.fanbox.cc/manage/relationships` ドメイン下のURLのみです。
* `proxy_id=[プロキシID]` : (任意) 使用するプロキシのID (`codetabs` または `allorigins`)。デフォルトは `codetabs`。
* `filter_plan=[プラン名1],[プラン名2],...` : (任意) 表示するプラン名をカンマ区切りで指定。指定しない場合は全プラン。プラン名に空白が含まれる場合はURLエンコードしてください。
* `filter_start_date_after=[YYYY-MM-DD]` : (任意) この日付以降に支援を開始したユーザーのみ。
* `filter_start_date_before=[YYYY-MM-DD]` : (任意) この日付以前に支援を開始したユーザーのみ。
* `filter_duration_months_over=[数値]` : (任意) 指定した月数以上、支援を継続しているユーザーのみ。
* `sort_by=[列キー]` : (任意) ソートする列のキー。指定可能なキー: `supporter_name`, `user_id`, `plan_name`, `start_date`, `memo`。
* `sort_order=[asc|desc]` : (任意) ソート順。`asc` (昇順) または `desc` (降順)。`sort_by` と共に使用。デフォルトは `asc`。
* `format=[csv|json]` : (必須、`download=true`の場合) ダウンロードするファイルの形式。
* `download=true` : (任意) このパラメータが存在する場合、処理完了後に自動的にファイルをダウンロードします。

**使用例:**
クリエイターID `mycreator` の支援者一覧から、「プレミアムプラン」と「スタンダードプラン」の支援者で、3ヶ月以上支援を継続しており、支援開始日の降順でソートし、CSV形式で自動ダウンロードする場合:

```
[https://kiyo.bio/Tools/FanboxEnumerator/?creator_id=mycreator&filter_plan=プレミアムプラン,スタンダードプラン&filter_duration_months_over=3&sort_by=start_date&sort_order=desc&format=csv&download=true](https://kiyo.bio/Tools/FanboxEnumerator/?creator_id=mycreator&filter_plan=プレミアムプラン,スタンダードプラン&filter_duration_months_over=3&sort_by=start_date&sort_order=desc&format=csv&download=true)
```
（実際のURLはホスティング場所に合わせてください）

### 1.4. 注意事項

* **FANBOXのHTML構造への依存:** このツールはPixiv FANBOXの「ファン一覧」ページのHTML構造を解析して情報を抽出します。FANBOX側のページデザインやHTML構造が大幅に変更された場合、ツールが正常に動作しなくなる可能性があります。その場合はツールのアップデートをお待ちください。
* **プロキシサーバー:** URLからのHTML読み込みは、CORS（Cross-Origin Resource Sharing）ポリシーを回避するために外部のプロキシサーバーを経由します。プロキシサーバーが不安定な場合やサービスを停止した場合は、読み込みに失敗することがあります。その際は、別のプロキシを選択するか、「HTMLを直接入力」する方法をお試しください。
* **利用規約の遵守:** Pixiv FANBOXの利用規約を遵守し、サーバーに過度な負荷をかけるような短時間での連続アクセスは避けてください。
* **自己責任での利用:** このツールを使用したことによるいかなる損害についても、作成者は責任を負いません。

## 2. 開発者（オーナー）のための備忘録

### 2.1. ツールの目的と構成

* **目的:** Pixiv FANBOXの支援者情報を手軽に抽出し、CSV/JSON形式でエクスポートすることで、支援者管理や関連タスクの自動化を支援する。
* **技術スタック:** HTML, CSS, Vanilla JavaScript (外部ライブラリ原則未使用)
* **ホスティング:** GitHub Pages (静的サイト)
* **主要な依存性:**
    * Pixiv FANBOXの `/manage/relationships` ページのHTML構造。
    * CORSプロキシサービス (codetabs, allorigins)。

### 2.2. AIへメンテナンスを指示する際の手順とポイント

このリポジトリのルートにある `README.md` の「AIへの初期指示プロンプト」に従ってください。
特にこのツール (`FanboxEnumerator`) のメンテナンスを依頼する際は、以下の点を明確に伝えてください。

1.  **対象ファイル:** `FanboxEnumerator/index.html`, `FanboxEnumerator/style.css`, `FanboxEnumerator/script.js`, `FanboxEnumerator/README.md`。
2.  **FANBOXのHTML構造の変更対応:**
    * もしFANBOX側のHTML構造が変更され、情報抽出がうまくいかなくなった場合、`script.js`内の`parseFanboxHtml`関数内のDOMセレクタの修正が必要です。
    * 具体的には、以下の情報を抽出するためのセレクタを見直す必要があります（2025年5月時点の想定セレクタ）:
        * 各支援者行: `div.commonStyles__Tr-sc-1f3w2vz-1.fsExkx`
        * 支援者名: 上記行内の1番目の`div.commonStyles__Td-sc-1f3w2vz-2.gOXCUW` -> `a.Row__UserWrapper-sc-1xb9lq9-1` -> `div.commonStyles__TextEllipsis-sc-1f3w2vz-3.bqBOcj` のテキスト
        * ユーザーID: 上記行内の1番目の`div.commonStyles__Td-sc-1f3w2vz-2.gOXCUW` -> `a.Row__UserWrapper-sc-1xb9lq9-1` の `href` 属性から抽出
        * プラン名: 上記行内の2番目の`div.commonStyles__Td-sc-1f3w2vz-2.gOXCUW` -> `div.commonStyles__TextEllipsis-sc-1f3w2vz-3.bqBOcj` のテキスト
        * 支援開始日: 上記行内の3番目の`div.commonStyles__Td-sc-1f3w2vz-2.gOXCUW` のテキスト
        * メモ: 上記行内の4番目の`div.commonStyles__Td-sc-1f3w2vz-2.gOXCUW` -> `div.commonStyles__TextEllipsis-sc-1f3w2vz-3.bqBOcj` のテキスト
    * 変更があった場合は、最新のFANBOX支援者一覧ページのHTMLソースを提供し、上記セレクタの更新を指示してください。
3.  **プロキシサーバーリストの更新:**
    * `script.js` 内の `proxies` 配列で定義されているプロキシサーバーが利用不可になった場合、代替の公開プロキシサービスを調査し、この配列を更新するよう指示してください。
4.  **機能追加・修正:**
    * 具体的な要望（例: 新しいフィルタ条件の追加、UIの改善など）を明確に伝えてください。
    * URLクエリパラメータに関する変更がある場合は、その仕様も詳細に指示してください。
5.  **バージョン情報と更新履歴:**
    * 変更後は、`index.html`内のバージョン情報と更新履歴、およびこの`README.md`の更新履歴の更新を指示してください。

### 2.3. このツール特有の技術的な注意点や重要な前提

* **HTML構造依存性:** 最も重要な注意点です。FANBOX側の変更に対して脆弱です。
* **CORSプロキシ依存性:** プロキシがダウンするとURLからの直接読み込み機能が使えなくなります。
* **日付のパース:** 支援開始日の文字列フォーマット（例: "YYYY年M月D日"）が変わると、期間計算やソートが正しく動作しなくなる可能性があります。`parseDate`関数を見直す必要があります。
* **URLクエリパラメータの処理:** `script.js` の `processUrlQueryParameters` 関数で処理しています。パラメータの追加や変更はここで行います。セキュリティ（特にURL検証）に注意が必要です。
* **GA4測定ID:** `index.html` にGA4測定ID (`G-WWQTE7VWKG`) が設定されています。新しいインタラクションを追加した場合は、関連イベントの送信を検討してください。

## 3. このツールのメンテナンスを行うAIへの指示書

### 3.1. はじめに・ツールの背景とあなたの役割

こんにちは。あなたはこの「FANBOX支援者リスト抽出ツール」のメンテナンスを担当するAIです。このツールは、オーナーがPixiv FANBOXの支援者情報を効率的に抽出し、管理作業を自動化・省力化するために開発されました。

あなたの役割は、オーナーからの修正や機能追加の要望に基づき、このツールのソースコード (`index.html`, `style.css`, `script.js`) およびこの `README.md` を適切に変更し、提案することです。

ツールは完全にクライアントサイドで動作する静的サイトとして、GitHub Pages上でホスティングされることを想定しています。

### 3.2. メンテナンスを依頼された場合の基本的な進め方

1.  **オーナーからの指示の正確な把握:**
    * 修正内容、追加機能、UIの変更点、特にFANBOX側のHTML構造の変更に関する情報を正確に理解してください。
    * オーナーから提供される最新のソースコードと、このREADME.md（特に「2.2. AIへメンテナンスを指示する際の手順とポイント」および「2.3. このツール特有の技術的な注意点や重要な前提」）を基に作業を行ってください。
2.  **影響範囲の特定と設計:**
    * 要望がツールのどの部分（HTML構造、CSSスタイル、JavaScriptロジック、特に`parseFanboxHtml`関数内のDOMセレクタ）に影響するかを特定してください。
3.  **コードの生成と提案:**
    * 変更が必要なファイルの**完全なソースコード**を提案してください。
4.  **バージョン情報と更新履歴の更新 (重要):**
    * オーナーから「バージョン情報と更新履歴を更新してください」という明確な指示があった場合に限り、以下の箇所を更新してください。
        * **`index.html` 内:**
            * `<p class="version-info">` タグ内の表示テキスト: 総リビジョン番号を現在の番号から1増やし、最終更新日を現在の日付（YYYY年MM月DD日形式）に更新。
            * `<meta name="version" content="N">`: 総リビジョン番号N（数字のみ）に更新。
            * `<meta name="last-updated" content="YYYY-MM-DD">`: 最終更新日をISO形式で更新。
            * `<div id="updateHistoryContentEl">`内の更新履歴リスト (`<ul>`): 今回の変更内容をリストアイテム(`<li>`)として、日付とリビジョン番号と共に**先頭に**追記。
        * **`README.md` (このファイル) 内:**
            * 「更新履歴」セクションに、今回の変更内容を、日付とリビジョン番号と共に**先頭に**追記。`index.html` に追記した内容と整合性を取ってください。
            * このREADME.md内の他のセクション（特にDOMセレクタに関する記述やURLクエリパラメータ仕様）で、今回の変更によって内容が古くなった箇所があれば、その修正も提案してください。
5.  **GA4イベントの考慮:**
    * 新しいユーザー操作が追加されたり、重要な処理フローが変更されたりした場合は、関連するGA4イベントを `script.js` 内に追加・修正することを検討し、オーナーに提案してください。

### 3.3. プロジェクト構造と主要ファイル

* `index.html`: メインページ。UI要素、静的テキスト（タイトル、説明、バージョン情報、**更新履歴本文**など）を含みます。
* `style.css`: 全てのスタイル定義。
* `script.js`: 全てのクライアントサイドロジック（DOM操作、イベント処理、HTML解析・生成、フィルタリング、ソート、エクスポート、URLクエリ処理、GA4イベント送信など）。
    * **特に重要な関数:** `parseFanboxHtml`, `applyAllFiltersAndRender`, `processUrlQueryParameters`。

### 3.4. FANBOX HTML構造の変更への対応

このツールはFANBOXのHTML構造に依存しているため、FANBOX側のアップデートでHTML構造が変わると動作しなくなる可能性があります。
メンテナンスの際は、まず `script.js` 内の `parseFanboxHtml` 関数にあるDOMセレクタが最新のFANBOXのHTML構造と一致しているか確認してください。
オーナーから最新の `relationships.html` のサンプルが提供された場合は、それを元にセレクタを検証・修正してください。

**主な確認箇所 (セレクタ):**

* 支援者一行ごとの要素
* 支援者名、ユーザーID、プラン名、支援開始日、メモを特定するための各要素のセレクタ

### 3.5. 将来的なワークフロー自動化の可能性について – あなたへの期待

「歌詞ページ印刷用整形ツール」のREADME.mdに記載されている内容と同様に、将来的にはより高度な開発支援（GitHub連携、プロキシ監視、対象サイト構造変更への自動または半自動対応提案など）が可能になることを期待しています。

## 更新履歴

* **2025年5月30日 (Rev. 1)**
    * 初回リリース。
    * HTMLソースからの支援者名、ユーザーID、プラン名、支援開始日、メモの抽出機能。
    * URLからのHTML読み込み機能（プロキシ経由）。
    * クリエイターIDからのURL自動生成機能。
    * プランフィルター（複数選択可）、支援期間フィルター機能。
    * 各列でのソート機能。
    * CSV、JSON形式でのダウンロード機能。
    * URLクエリパラメータによる一部自動操作対応。

